#!/bin/bash
#
# Panel using lemonbar.

FIFO="/tmp/panel-fifo"

HEIGHT=41
LINE_HEIGHT=13
FONT="Roboto:size=10"
COLOR_FG="#ffffd7af"
COLOR_BG="#ff252525"
COLOR_ACTIVE="#ff544f4c"
COLOR_INACTIVE="#ff353535"

BLOCK="                "

panel_bar() {
  while read -r line; do
    case $line in
      # xtitle
      T*)
        line=${line#?}
        title="%{F$COLOR_FG}  ${line/${USER}@${HOSTNAME}:/${TERMINAL}: }"
        ;;
      # bspwm
      W*)
        wm_infos=""
        IFS=":"
        set -- ${line#?}
        while [ $# -gt 0 ] ; do
          item="$1"
          name="${item#?}"
          case "$item" in
            # active desktop
            [OFU]*) wm_infos=" ${wm_infos}%{U$COLOR_ACTIVE}%{+u}${BLOCK}%{-u}   " ;;
            # inactive desktop
            [ofu]*) wm_infos=" ${wm_infos}%{U$COLOR_INACTIVE}%{+u}${BLOCK}%{-u}   " ;;
          esac
          shift
        done
        wm_infos="$wm_infos "
        ;;
      # clock
      C*)
        line=${line#?}
        sys_infos="%{F$COLOR_FG}${line,,}  "
        ;;
    esac
    printf "%s\n" "%{l}${title} %{c}${wm_infos} %{r}${sys_infos}"
  done
}

if [[ $(pgrep -cx panel) -gt 1 ]]; then
  printf "%s\n" "The panel is already running." >&2
  exit 1
fi

trap "trap - TERM; kill 0" INT TERM QUIT EXIT

[[ -e "$FIFO" ]] && rm "$FIFO"
mkfifo "$FIFO"

bspc control --subscribe > "$FIFO" &
xtitle -sf "T%s" -t 100 > "$FIFO" &
clock -sf "C%a %d %b %H:%M" > "$FIFO" &

cat "$FIFO" | panel_bar | lemonbar -g x"$HEIGHT" -f "$FONT" -F "$COLOR_ACTIVE" -B "$COLOR_BG" -u "$LINE_HEIGHT" &

wait
